<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.varc.brewnetapp.domain.exchange.query.mapper.ExchangeMapper">
    <resultMap id="exchangeListResultMap" type="com.varc.brewnetapp.domain.exchange.query.aggregate.vo.ExchangeListVO">
        <result property="exchangeCode" column="exchange_code"/>
        <result property="franchiseName" column="franchise_name"/>
        <result property="itemName" column="item_name"/>
        <result property="reason" column="reason"/>
        <result property="memberCode" column="member_name"/>
        <result property="createdAt" column="created_at"/>
        <result property="status" column="status"/>
        <result property="approved" column="approved"/>
    </resultMap>
    <select id="selectExchangeListCnt" resultType="int">
        SELECT
              COUNT(*)
          FROM tbl_exchange A
              JOIN tbl_order B ON A.order_code = B.order_code
              JOIN tbl_franchise C ON B.franchise_code = C.franchise_code
              JOIN tbl_exchange_item D ON A.exchange_code = D.exchange_code
              JOIN tbl_item E ON D.item_code = E.item_code
              JOIN tbl_member F ON A.member_code = F.member_code
              JOIN tbl_exchange_status_history G ON A.exchange_code = G.exchange_code
              JOIN (
                    SELECT exchange_code, MAX(created_at) AS max_created_at
                      FROM tbl_exchange_status_history
                     GROUP BY exchange_code
              ) latest_status ON G.exchange_code = latest_status.exchange_code
          AND G.created_at = latest_status.max_created_at;
    </select>
    <select id="selectExchangeList" resultMap="exchangeListResultMap">
        SELECT
              A.exchange_code,
              C.franchise_name,
              GROUP_CONCAT(E.name SEPARATOR ', ') AS item_name,
              A.reason,
              F.name AS member_name,
              A.created_at,
              G.status,
              A.approved
         FROM tbl_exchange A
              JOIN tbl_order B ON A.order_code = B.order_code
              JOIN tbl_franchise C ON B.franchise_code = C.franchise_code
              JOIN tbl_exchange_item D ON A.exchange_code = D.exchange_code
              JOIN tbl_item E ON D.item_code = E.item_code
              JOIN tbl_member F ON A.member_code = F.member_code
              JOIN tbl_exchange_status_history G ON A.exchange_code = G.exchange_code
              JOIN (
                    SELECT exchange_code, MAX(created_at) AS max_created_at
                    FROM tbl_exchange_status_history
                    GROUP BY exchange_code
                    ) latest_status ON G.exchange_code = latest_status.exchange_code
          AND G.created_at = latest_status.max_created_at
        GROUP BY A.exchange_code, C.franchise_name, A.reason, F.name, A.created_at, G.status, A.approved
        LIMIT ${ offset }, ${ pageSize };
    </select>
</mapper>