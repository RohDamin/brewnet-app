<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.varc.brewnetapp.domain.exchange.query.mapper.ExchangeMapper">
    <resultMap id="exchangeListResultMap" type="com.varc.brewnetapp.domain.exchange.query.aggregate.vo.ExchangeListVO">
        <result property="exchangeCode" column="exchange_code"/>
        <result property="franchiseName" column="franchise_name"/>
        <result property="itemName" column="item_name"/>
        <result property="reason" column="reason"/>
        <result property="memberCode" column="member_name"/>
        <result property="createdAt" column="created_at"/>
        <result property="status" column="status"/>
        <result property="approved" column="approved"/>
    </resultMap>

    <resultMap id="exchangeDetailItemResultMap" type="com.varc.brewnetapp.domain.exchange.query.aggregate.vo.ExchangeItemVO">
        <result property="itemUniqueCode" column="item_unique_code"/>
        <result property="itemName" column="item_name"/>
        <result property="superCategory" column="super_category"/>
        <result property="subCategory" column="sub_category"/>
        <result property="quantity" column="quantity"/>
    </resultMap>

    <resultMap id="exchangeDetailResultMap" type="com.varc.brewnetapp.domain.exchange.query.aggregate.vo.ExchangeDetailVO">
        <id property="exchangeCode" column="exchange_code" />
        <result property="createdAt" column="created_at"/>
        <result property="franchiseName" column="franchise_name"/>
        <result property="reason" column="reason"/>
        <result property="memberName" column="member_name"/>
        <result property="comment" column="comment"/>
        <result property="explanation" column="explanation"/>

        <!-- 교환 물품 리스트 매핑 -->
        <collection property="exchangeItemList" ofType="com.varc.brewnetapp.domain.exchange.query.aggregate.vo.ExchangeItemVO"
                    select="selectExchangeDetailItemBy" column="exchange_code"/>

        <!-- 교환 이미지 리스트 매핑 -->
        <collection property="exchangeImageList" ofType="java.lang.String"
                    select="selectExchangeDetailImageBy" column="exchange_code"/>
    </resultMap>

    <resultMap id="exchangeHistoryListResultMap" type="com.varc.brewnetapp.domain.exchange.query.aggregate.vo.ExchangeHistoryVO">
        <id property="exchangeStockHistoryCode" column="exchange_stock_history_code"/>
        <result property="status" column="status"/>
        <result property="manager" column="manager"/>
        <result property="createdAt" column="created_at"/>
        <result property="confirmed" column="confirmed"/>
        <result property="exchangeCode" column="exchange_code"/>
        <result property="exchangeManager" column="exchange_manager"/>
    </resultMap>

    <!-- 타부서 교환처리완료내역 상세조회 ResultMap -->
    <resultMap id="exchangeHistoryDetailResultMap" type="com.varc.brewnetapp.domain.exchange.query.aggregate.vo.ExchangeHistoryDetailVO">
        <id property="exchangeStockHistoryCode" column="exchange_stock_history_code"/>
        <result property="exchangeCreatedAt" column="exchange_created_at"/>
        <result property="franchiseName" column="manager"/>
        <result property="reason" column="reason"/>
        <result property="exchangeManager" column="exchange_manager"/>
        <result property="comment" column="comment"/>
        <result property="createdAt" column="created_at"/>
        <result property="status" column="status"/>
        <result property="manager" column="manager"/>

        <!-- 타부서 교환처리완료내역 물품 리스트 매핑 -->
        <collection property="exchangeHistoryItemList" ofType="com.varc.brewnetapp.domain.exchange.query.aggregate.vo.ExchangeHistoryItemVO"
                    select="selectExchangeHistoryDetailItemBy" column="exchange_stock_history_code"/>
    </resultMap>

    <!-- 타부서 교환처리완료내역 물품 ResultMap -->
    <resultMap id="exchangeHistoryDetailItemResultMap" type="com.varc.brewnetapp.domain.exchange.query.aggregate.vo.ExchangeHistoryItemVO">
        <result property="itemUniqueCode" column="item_unique_code"/>
        <result property="itemName" column="item_name"/>
        <result property="superCategory" column="super_category"/>
        <result property="subCategory" column="sub_category"/>
        <result property="quantity" column="quantity"/>
        <result property="restockQuantity" column="restock_quantity"/>
    </resultMap>

    <select id="selectExchangeListCnt" resultType="int">
        SELECT
              COUNT(*)
          FROM tbl_exchange A
              JOIN tbl_order B ON A.order_code = B.order_code
              JOIN tbl_franchise C ON B.franchise_code = C.franchise_code
              JOIN tbl_exchange_item D ON A.exchange_code = D.exchange_code
              JOIN tbl_item E ON D.item_code = E.item_code
              JOIN tbl_member F ON A.member_code = F.member_code
              JOIN tbl_exchange_status_history G ON A.exchange_code = G.exchange_code
              JOIN (
                    SELECT exchange_code, MAX(created_at) AS max_created_at
                      FROM tbl_exchange_status_history
                     GROUP BY exchange_code
              ) latest_status ON G.exchange_code = latest_status.exchange_code
          AND G.created_at = latest_status.max_created_at;
    </select>

    <select id="selectExchangeList" resultMap="exchangeListResultMap">
        SELECT
              A.exchange_code
            , C.franchise_name
            , GROUP_CONCAT(E.name SEPARATOR ', ') AS item_name
            , A.reason
            , F.name AS member_name
            , A.created_at
            , G.status
            , A.approved
         FROM tbl_exchange A
              JOIN tbl_order B ON A.order_code = B.order_code
              JOIN tbl_franchise C ON B.franchise_code = C.franchise_code
              JOIN tbl_exchange_item D ON A.exchange_code = D.exchange_code
              JOIN tbl_item E ON D.item_code = E.item_code
              JOIN tbl_member F ON A.member_code = F.member_code
              JOIN tbl_exchange_status_history G ON A.exchange_code = G.exchange_code
              JOIN (
                    SELECT exchange_code, MAX(created_at) AS max_created_at
                    FROM tbl_exchange_status_history
                    GROUP BY exchange_code
                    ) latest_status ON G.exchange_code = latest_status.exchange_code
          AND G.created_at = latest_status.max_created_at
        GROUP BY A.exchange_code, C.franchise_name, A.reason, F.name, A.created_at, G.status, A.approved
        LIMIT #{ offset }, #{ pageSize };
    </select>

    <select id="selectSearchExchangeList" resultMap="exchangeListResultMap">
        SELECT
              A.exchange_code
            , C.franchise_name
            , GROUP_CONCAT(E.name SEPARATOR ', ') AS item_name
            , A.reason
            , F.name AS member_name
            , A.created_at
            , G.status
            , A.approved
         FROM tbl_exchange A
              JOIN tbl_order B ON A.order_code = B.order_code
              JOIN tbl_franchise C ON B.franchise_code = C.franchise_code
              JOIN tbl_exchange_item D ON A.exchange_code = D.exchange_code
              JOIN tbl_item E ON D.item_code = E.item_code
              JOIN tbl_member F ON A.member_code = F.member_code
              JOIN tbl_exchange_status_history G ON A.exchange_code = G.exchange_code
              JOIN (
                    SELECT exchange_code, MAX(created_at) AS max_created_at
                    FROM tbl_exchange_status_history
                    GROUP BY exchange_code
                    ) latest_status ON G.exchange_code = latest_status.exchange_code
          AND G.created_at = latest_status.max_created_at
        <where>
            <choose>
                <when test="searchFilter == 'exchangeCode'">
                    AND CAST(A.exchange_code AS CHAR) LIKE CONCAT('%', #{ searchWord }, '%')
                </when>
                <when test="searchFilter == 'franchiseName'">
                    AND C.franchise_name LIKE CONCAT('%', #{ searchWord }, '%')
                </when>
                <when test="searchFilter == 'managerName'">
                    AND F.name LIKE CONCAT('%', #{ searchWord }, '%')
                </when>
            </choose>
            <if test="startDate != null and endDate != null">
                AND A.created_at BETWEEN #{ startDate } AND CONCAT(#{ endDate }, ' 23:59:59')
            </if>
        </where>
        GROUP BY A.exchange_code, C.franchise_name, A.reason, F.name, A.created_at, G.status, A.approved
        LIMIT #{ offset }, #{ pageSize };
    </select>

    <select id="selectExchangeDetailBy" resultMap="exchangeDetailResultMap">
        SELECT
              A.exchange_code
            , A.created_at
            , C.franchise_name
            , A.reason
            , D.name AS member_name
            , A.comment
            , A.explanation
         FROM tbl_exchange A
              JOIN tbl_order B ON A.order_code = B.order_code
              JOIN tbl_franchise C ON B.franchise_code = C.franchise_code
              JOIN tbl_member D ON A.member_code = D.member_code
        WHERE A.exchange_code = #{ exchangeCode };
    </select>

    <select id="selectExchangeDetailImageBy" resultType="string">
        SELECT
              A.image_url
         FROM tbl_exchange_img A
        WHERE A.exchange_code = #{ exchangeCode };
    </select>

    <select id="selectExchangeDetailItemBy" resultMap="exchangeDetailItemResultMap">
        SELECT
              B.item_unique_code
            , B.name AS item_name
            , C.name AS sub_category
            , D.name AS super_category
            , A.quantity
         FROM tbl_exchange_item A
              JOIN tbl_item B ON A.item_code = B.item_code
              JOIN tbl_sub_category C ON B.category_code = C.sub_category_code
              JOIN tbl_super_category D ON C.super_category_code = D.super_category_code
        WHERE A.exchange_code = #{ exchangeCode };
    </select>

    <select id="selectExchangeHistoryListCnt" resultType="int">
        SELECT
              count(*)
         FROM tbl_exchange_stock_history A
              JOIN tbl_exchange B ON A.exchange_code = B.exchange_code
              JOIN tbl_member C ON B.member_code = C.member_code;
    </select>

    <select id="selectExchangeHistoryList" resultMap="exchangeHistoryListResultMap">
        SELECT
              A.exchange_stock_history_code
            , A.status
            , A.manager
            , A.created_at
            , A.confirmed
            , A.exchange_code
            , C.name AS exchange_manager
         FROM tbl_exchange_stock_history A
              JOIN tbl_exchange B ON A.exchange_code = B.exchange_code
              JOIN tbl_member C ON B.member_code = C.member_code
        LIMIT #{ offset }, #{ pageSize };
    </select>

    <!-- 타부서 교환처리완료내역 상세조회 쿼리 -->
    <select id="selectExchangeHistoryDetailBy" resultMap="exchangeHistoryDetailResultMap">
        SELECT
              A.exchange_stock_history_code
            , B.created_at AS exchange_create_at
            , D.franchise_name
            , B.reason
            , B.member_code AS exchange_manager
            , A.comment
            , A.created_at
            , A.status
            , A.manager
         FROM tbl_exchange_stock_history A
              JOIN tbl_exchange B ON A.exchange_code = B.exchange_code
              JOIN tbl_order C ON B.order_code = C.order_code
              JOIN tbl_franchise D ON C.franchise_code = D.franchise_code
        WHERE A.exchange_stock_history_code = #{ exchangeStockHistoryCode };
    </select>

    <!-- 타부서 교환처리완료내역 물품 쿼리 -->
    <select id="selectExchangeHistoryDetailItemBy" resultMap="exchangeHistoryDetailItemResultMap">
        SELECT
              B.item_unique_code
            , B.name AS item_name
            , C.name AS sub_category
            , D.name AS super_category
            , A.quantity
            , A.restock_quantity
        FROM tbl_exchange_item_status A
              JOIN tbl_item B ON A.item_code = B.item_code
              JOIN tbl_sub_category C ON B.category_code = C.sub_category_code
              JOIN tbl_super_category D ON C.super_category_code = D.super_category_code
        WHERE A.exchange_stock_history_code = #{ exchangeStockHistoryCode };
    </select>

</mapper>