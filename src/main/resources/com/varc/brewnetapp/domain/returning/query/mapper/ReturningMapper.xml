<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.varc.brewnetapp.domain.returning.query.mapper.ReturningMapper">

    <!-- ========== resultMap ========== -->

    <!-- 본사 반품요청 목록조회 ResultMap -->
    <resultMap id="returningListResultMap" type="com.varc.brewnetapp.domain.returning.query.aggregate.vo.ReturningListVO">
        <result property="returningCode" column="returning_code"/>
        <result property="franchiseName" column="franchise_name"/>
        <result property="itemName" column="item_name"/>
        <result property="reason" column="reason"/>
        <result property="memberCode" column="member_name"/>
        <result property="createdAt" column="created_at"/>
        <result property="status" column="status"/>
        <result property="approvalStatus" column="approval_status"/>
    </resultMap>

    <!-- ========== Query ========== -->

    <!-- ===== Query 1. 교환내역 ===== -->

    <!-- 반품내역 목록조회 페이지네이션용 cnt 쿼리 -->
    <select id="selectReturningListCnt" resultType="int">
        SELECT
              COUNT(*)
          FROM (
                 SELECT
                        A.return_code
                      , C.franchise_name
                      , GROUP_CONCAT(E.name SEPARATOR ', ') AS item_name
                      , A.reason
                      , F.name AS member_name
                      , A.created_at
                      , G.status
                      , A.approval_status
                   FROM tbl_return A
                        JOIN tbl_order B ON A.order_code = B.order_code
                        JOIN tbl_franchise C ON B.franchise_code = C.franchise_code
                        JOIN tbl_return_item D ON A.return_code = D.return_code
                        JOIN tbl_item E ON D.item_code = E.item_code
                        LEFT JOIN tbl_member F ON A.member_code = F.member_code
                        JOIN tbl_return_status_history G ON A.return_code = G.return_code
                        JOIN (
                               SELECT return_code, MAX(created_at) AS max_created_at
                               FROM tbl_return_status_history
                               GROUP BY return_code
                        ) latest_status ON G.return_code = latest_status.return_code
                          AND G.created_at = latest_status.max_created_at
                    GROUP BY A.return_code
                 ) As grouped_result;
    </select>

    <!-- 반품내역 목록조회 쿼리 -->
    <select id="selectReturningList" resultMap="returningListResultMap">
        SELECT
              A.return_code
              , C.franchise_name
              , GROUP_CONCAT(E.name SEPARATOR ', ') AS item_name
              , A.reason
              , F.name AS member_name
              , A.created_at
              , G.status
              , A.approval_status
         FROM tbl_return A
              JOIN tbl_order B ON A.order_code = B.order_code
              JOIN tbl_franchise C ON B.franchise_code = C.franchise_code
              JOIN tbl_return_item D ON A.return_code = D.return_code
              JOIN tbl_item E ON D.item_code = E.item_code
              LEFT JOIN tbl_member F ON A.member_code = F.member_code
              JOIN tbl_return_status_history G ON A.return_code = G.return_code
              JOIN (
                    SELECT return_code, MAX(created_at) AS max_created_at
                    FROM tbl_return_status_history
                    GROUP BY return_code
                    ) latest_status ON G.return_code = latest_status.return_code
          AND G.created_at = latest_status.max_created_at
        GROUP BY A.return_code, A.created_at
        ORDER BY A.created_at DESC
        LIMIT #{ offset }, #{ pageSize };
    </select>
</mapper>