<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.varc.brewnetapp.domain.order.query.mapper.OrderMapper">

    <!-- resultMaps-->
    <resultMap id="baseOrderList" type="com.varc.brewnetapp.domain.order.query.dto.OrderDTO">
        <id property="orderCode" column="ORDER_CODE"/>
        <result property="comment" column="COMMENT"/>
        <result property="createdAt" column="CREATED_AT"/>
        <result property="active" column="ACTIVE"/>
        <result property="approvalStatus" column="APPROVAL_STATUS"/>
        <result property="drafterApproved" column="DRAFTER_APPROVED"/>
        <result property="sumPrice" column="SUM_PRICE"/>
    </resultMap>

    <resultMap id="OrderDTOResultList" type="com.varc.brewnetapp.domain.order.query.dto.OrderDTO">
        <id property="orderCode" column="ORDER_CODE"/>
<!--        <result property="comment" column="COMMENT"/>-->
        <result property="createdAt" column="CREATED_AT"/>
        <result property="active" column="ACTIVE"/>
        <result property="approvalStatus" column="APPROVAL_STATUS"/>
        <result property="drafterApproved" column="DRAFTER_APPROVED"/>
        <result property="sumPrice" column="SUM_PRICE"/>

        <!-- orderFranchise-->
        <association property="orderFranchise"
                     javaType="com.varc.brewnetapp.domain.order.query.dto.OrderFranchise">
            <id property="franchiseCode" column="FRANCHISE_CODE" />
            <result property="franchiseName" column="FRANCHISE_NAME" />
            <result property="address" column="ADDRESS" />
            <result property="detailAddress" column="DETAIL_ADDRESS" />
            <result property="city" column="CITY" />
            <result property="contact" column="CONTACT" />
            <result property="createdAt" column="FRANCHISE_CREATED_AT" />
        </association>

        <!-- orderItems-->
        <collection property="orderItemList"
                    ofType="com.varc.brewnetapp.domain.order.query.dto.OrderItem"
                    javaType="java.util.List"
        >
            <id property="itemCode" column="ITEM_CODE"/>
            <result property="quantity" column="QUANTITY" />
            <result property="available" column="AVAILABLE" />
            <result property="partSumPrice" column="PART_SUM_PRICE" />

            <result property="name" column="ITEM_NAME" />
            <result property="purchasePrice" column="PURCHASE_PRICE" />
            <result property="categoryName" column="SUB_CATEGORY_NAME" />
        </collection>

        <!-- orderStatusHistories-->
        <collection property="orderStatusHistoryList"
                    ofType="com.varc.brewnetapp.domain.order.query.dto.OrderStatusHistory"
                    javaType="java.util.List"
        >
            <id property="orderStatusHistoryCode" column="ORDER_STATUS_HISTORY_CODE"/>
<!--            <result property="orderHistoryStatus" column="ORDER_HISTORY_STATUS" />-->
            <result property="createdAt" column="HISTORY_CREATED_AT" />
        </collection>
    </resultMap>


    <!-- test-->
    <select id="findOrdersBy" resultMap="OrderDTOResultList">
        SELECT
              O.ORDER_CODE
            , O.COMMENT
            , O.CREATED_AT
            , O.ACTIVE
            , O.APPROVAL_STATUS
            , O.DRAFTER_APPROVED
            , O.SUM_PRICE
         FROM tbl_order O
        ORDER BY CREATED_AT
    </select>

    <!-- common-->
    <select id="countOrders" resultType="int">
        SELECT COUNT(*)
        FROM tbl_order O
        WHERE 1=1
        <if test="filter == 'UNCONFIRMED'">
            AND O.APPROVED = #{filter}
        </if>
    </select>

    <!-- for HQ-->
    <select id="findOrdersForHQBy" resultMap="OrderDTOResultList">
        SELECT
               o.ORDER_CODE
<!--             , o.COMMENT-->
             , o.CREATED_AT
             , o.ACTIVE
             , o.APPROVAL_STATUS
             , o.DRAFTER_APPROVED
             , o.SUM_PRICE
             , f.FRANCHISE_CODE
             , f.FRANCHISE_NAME
             , f.ADDRESS
             , f.DETAIL_ADDRESS
             , f.CITY
             , f.CONTACT
             , f.CREATED_AT as FRANCHISE_CREATED_AT
             , oi.ITEM_CODE
             , oi.QUANTITY
             , oi.AVAILABLE
             , oi.PART_SUM_PRICE
             , i.NAME as ITEM_NAME
             , i.PURCHASE_PRICE
             , sc.NAME as SUB_CATEGORY_NAME
             , os.ORDER_STATUS_HISTORY_CODE
<!--             , os.STATUS as ORDER_HISTORY_STATUS-->
             , os.CREATED_AT as HISTORY_CREATED_AT

          FROM tbl_order o

          LEFT JOIN
               tbl_franchise f ON o.FRANCHISE_CODE = f.FRANCHISE_CODE
          LEFT JOIN
               tbl_order_item oi ON o.ORDER_CODE = oi.ORDER_CODE
          LEFT JOIN
               tbl_item i ON oi.ITEM_CODE = i.ITEM_CODE
          LEFT JOIN
               tbl_sub_category sc ON i.CATEGORY_CODE = sc.SUB_CATEGORY_CODE
          LEFT JOIN
               tbl_order_status_history os ON o.ORDER_CODE = os.ORDER_CODE

         WHERE o.ACTIVE = 1
        <if test="filter == 'UNCONFIRMED'">
           AND o.APPROVED = #{filter}
        </if>

        <choose>
            <when test="sort == 'createdAtDesc'">
                ORDER BY o.CREATED_AT DESC
            </when>
            <when test="sort == 'createdAtAsc'">
                ORDER BY o.CREATED_AT ASC
            </when>
            <when test="sort == 'sumPriceDesc'">
                ORDER BY o.SUM_PRICE DESC
            </when>
            <when test="sort == 'sumPriceAsc'">
                ORDER BY o.SUM_PRICE ASC
            </when>
            <otherwise>
                <!-- 기본 정렬 -->
                ORDER BY o.CREATED_AT DESC
            </otherwise>
        </choose>
        LIMIT #{size} OFFSET #{offset}
    </select>
</mapper>