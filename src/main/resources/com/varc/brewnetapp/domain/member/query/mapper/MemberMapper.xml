<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.varc.brewnetapp.domain.member.query.mapper.MemberMapper">

  <resultMap id="memberResultMap" type="com.varc.brewnetapp.domain.member.query.dto.MemberDTO">
    <id property="memberCode" column="MEMBER_CODE"/>
    <result property="id" column="ID"/>
    <result property="name" column="NAME"/>
    <result property="email" column="EMAIL"/>
    <result property="contact" column="CONTACT"/>
    <result property="signatureUrl" column="SIGNATURE_URL"/>
    <result property="positionName" column="POSITION_NAME"/>
    <result property="roles" column="ROLES"/>
  </resultMap>
  
  <resultMap id="companyResultMap" type="com.varc.brewnetapp.domain.member.query.dto.CompanyDTO">
    <id property="companyCode" column="COMPANY_CODE"/>
    <result property="name" column="NAME"/>
    <result property="businessNumber" column="BUSINESS_NUMBER"/>
    <result property="corporateNumber" column="CORPORATE_NUMBER"/>
    <result property="ceoName" column="CEO_NAME"/>
    <result property="address" column="ADDRESS"/>
    <result property="typeOfBusiness" column="TYPE_OF_BUSINESS"/>
    <result property="contact" column="CONTACT"/>
    <result property="dateOfEstablishment" column="DATE_OF_ESTABLISHMENT"/>
  </resultMap>

  <resultMap id="sealResultMap" type="com.varc.brewnetapp.domain.member.query.dto.SealDTO">
    <id property="sealCode" column="SEAL_CODE"/>
    <result property="imageUrl" column="IMAGE_URL"/>
  </resultMap>

  <select id="selectMemberList" resultMap="memberResultMap" parameterType="map">
    SELECT
           M.MEMBER_CODE,
           M.ID,
           M.NAME,
           M.EMAIL,
           M.CONTACT,
           M.SIGNATURE_URL,
           P.NAME AS POSITION_NAME,
           (SELECT GROUP_CONCAT(R.ROLE SEPARATOR ', ')
           FROM tbl_member_role MR
           INNER JOIN tbl_role R
           ON MR.ROLE_CODE = R.ROLE_CODE
           WHERE MR.MEMBER_CODE = M.MEMBER_CODE) AS ROLES
      FROM tbl_member M
     INNER JOIN tbl_position P
        ON M.POSITION_CODE = P.POSITION_CODE
     WHERE M.ACTIVE = TRUE
      <if test="search != null and search != ''">
       AND M.NAME LIKE CONCAT('%', #{search}, '%')
      </if>
     ORDER BY M.MEMBER_CODE DESC
     LIMIT #{ pageSize }
    OFFSET #{ offset };
  </select>

  <select id="selectMemberListCnt" resultType="int">
    SELECT COUNT(*)
      FROM tbl_member
     WHERE ACTIVE = TRUE
  </select>

  <select id="selectCompany" resultMap="companyResultMap">
    SELECT
           COMPANY_CODE,
           NAME,
           BUSINESS_NUMBER,
           CORPORATE_NUMBER,
           CEO_NAME,
           ADDRESS,
           TYPE_OF_BUSINESS,
           CONTACT,
           DATE_OF_ESTABLISHMENT
      FROM tbl_company
     ORDER BY COMPANY_CODE ASC
     LIMIT 1
  </select>

  <select id="selectCompanySeal" resultMap="sealResultMap">
    SELECT
           SEAL_CODE,
           IMAGE_URL
      FROM tbl_seal
     ORDER BY SEAL_CODE ASC
     LIMIT 1
  </select>

  <select id="selectMember" resultMap="memberResultMap" parameterType="string">
    SELECT
           M.MEMBER_CODE,
           M.ID,
           M.NAME,
           M.EMAIL,
           M.CONTACT,
           M.SIGNATURE_URL,
           P.NAME AS POSITION_NAME,
           (SELECT GROUP_CONCAT(R.ROLE SEPARATOR ', ')
              FROM tbl_member_role MR
             INNER JOIN tbl_role R
                ON MR.ROLE_CODE = R.ROLE_CODE
             WHERE MR.MEMBER_CODE = M.MEMBER_CODE) AS ROLES
      FROM tbl_member M
     INNER JOIN tbl_position P
        ON M.POSITION_CODE = P.POSITION_CODE
     WHERE M.ACTIVE = TRUE AND M.ID = #{ loginId }
  </select>

</mapper>